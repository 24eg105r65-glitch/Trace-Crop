<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title> | Register</title>
    <link rel="stylesheet" href="style.css">
    <style>
        /* Force option text color to be visible */
        select option {
            background-color: #fff;
            color: #333;
        }
        /* Specific dark theme for modal select options if supported */
        #googleRoleSelect option {
            background-color: #333;
            color: #fff;
        }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <h1>JOIN TRACECROP</h1>

        <form id="signupForm">
            <input type="text" placeholder="Full Name" required>
            <input type="email" placeholder="Email Address" required>

            <div class="row">
                <select id="roleSelect" required>
                    <option value="">-Select role-</option>
                    <option value="Farmer">Farmer</option>
                    <option value="Distributor">Distributor</option>
                    <option value="Quality Auditor">Quality Auditor</option>
                    <option value="Government">Government</option>
                    <option value="Consumer">Consumer</option>
                </select>
            </div>

            <input type="password" placeholder="Password" required>
            <input type="password" placeholder="Confirm Password" required>

            <button type="submit">CREATE ACCOUNT</button>

            <div style="text-align: center; margin: 15px 0;">
                <span style="color: #aaa; font-size: 12px;">OR</span>
            </div>
            
            <button type="button" id="googleBtn" style="background: #fff; color: #333; border: 1px solid #ccc; display: flex; align-items: center; justify-content: center; gap: 10px; font-weight: bold;">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="18"> Sign up with Google
            </button>

            <p class="login-text">Already have an account? <a href="login.html" style="color: #4caf50; text-decoration: none;">Login</a></p>
            <div id="google_translate_element" style="margin-bottom: 20px; text-align: center;"></div>

        </form>
    </div>
</div>

<!-- Floating Help Button -->
<button onclick="toggleHelpModal()" style="position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; background: #4caf50; color: white; border: none; box-shadow: 0 5px 15px rgba(0,255,100,0.3); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 1000; transition: 0.3s; transform: scale(1);" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
    <svg width="30" height="30" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"></path><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
</button>

<!-- Help Video Modal -->
<div id="helpModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; justify-content: center; align-items: center; backdrop-filter: blur(5px);">
    <div style="background: #222; padding: 20px; border-radius: 12px; width: 90%; max-width: 800px; position: relative; border: 1px solid rgba(0,255,100,0.2);">
        <button onclick="toggleHelpModal()" style="position: absolute; top: -15px; right: -15px; width: 35px; height: 35px; border-radius: 50%; background: #f44336; color: white; border: none; cursor: pointer; font-weight: bold; font-size: 20px; box-shadow: 0 0 10px rgba(0,0,0,0.5);">&times;</button>
        <h3 style="color: white; margin-top: 0; margin-bottom: 20px; text-align: center; letter-spacing: 1px;">SYSTEM TEST DEMO</h3>
        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 8px; border: 1px solid #444;">
            <img src="testing_demo.webp" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: contain; background: #000;" alt="Testing Demo">
        </div>
        <p style="color: #ccc; font-size: 14px; text-align: center; margin-top: 20px; font-style: italic;">
            This video demonstrates the automated verification of the platform roles and data flow.
        </p>
    </div>
</div>

<script>
    function toggleHelpModal() {
        const modal = document.getElementById('helpModal');
        if (modal.style.display === 'none') {
            modal.style.display = 'flex';
        } else {
            modal.style.display = 'none';
        }
    }
</script>

<!-- Role Selection Modal for New Google Users -->
<div id="roleModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;">
    <div style="background: #222; padding: 30px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); width: 90%; max-width: 400px; text-align: center;">
        <h3 style="margin-top: 0;">Complete Your Profile</h3>
        <p style="color: #ccc; font-size: 14px; margin-bottom: 20px;">Please select your role to continue.</p>
        
        <select id="googleRoleSelect" style="width: 100%; padding: 12px; margin-bottom: 20px; background: rgba(255,255,255,0.1); border: 1px solid #444; color: white; border-radius: 4px;">
            <option value="Farmer">Farmer</option>
            <option value="Distributor">Distributor</option>
            <option value="Quality Auditor">Quality Auditor</option>
            <option value="Consumer">Consumer</option>
            <option value="Government">Government</option>
        </select>
        
        <button onclick="finishGoogleSignup()" style="width: 100%; padding: 12px; background: #4caf50; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer;">CONTINUE AS <span id="roleBtnText">FARMER</span></button>
    </div>
</div>

<!-- Success Modal -->
<div id="successModal">
    <div id="successModalContent">
        <div class="success-icon">
             <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                 <circle class="checkmark__circle" cx="26" cy="26" r="25" fill="none"/>
                 <path class="checkmark__check" fill="none" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
             </svg>
        </div>
        <h2>Success!</h2>
        <p>Your account has been created successfully.</p>
        <p style="font-size: 14px; opacity: 0.7;">Redirecting to login...</p>
    </div>
</div>

<script type="module">
    import { auth, db, createUserWithEmailAndPassword, setDoc, doc, provider, signInWithPopup, getDoc } from './firebase-config.js?v=2';

    let pendingGoogleUser = null;

    // Role Select Update
    document.getElementById('googleRoleSelect').addEventListener('change', function() {
        document.getElementById('roleBtnText').innerText = this.value.toUpperCase();
    });

    // Google Sign Up Logic
    document.getElementById('googleBtn').addEventListener('click', async () => {
        const btn = document.getElementById('googleBtn');
        const roleFromForm = document.getElementById('roleSelect').value;
        const originalText = btn.innerHTML;
        btn.innerHTML = 'Connecting...';
        
        try {
            const result = await signInWithPopup(auth, provider);
            const user = result.user;
            
            // Check if profile already exists
            const docRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(docRef);
            
            if (docSnap.exists()) {
                // Already signed up, just redirect
                alert("Account already exists! Logging you in...");
                handleRedirect(docSnap.data().role);
            } else {
                // New User
                if (roleFromForm) {
                    // Role selected in main form, use it directly
                    await saveUserProfile(user, roleFromForm);
                } else {
                    // Show Modal
                    pendingGoogleUser = user;
                    document.getElementById('roleModal').style.display = 'flex';
                    btn.innerHTML = originalText;
                }
            }

        } catch (error) {
            console.error(error);
            alert("Google Sign Up Error: " + error.message);
            btn.innerHTML = originalText;
        }
    });

    // Finish Signup Logic (from Modal)
    window.finishGoogleSignup = async function() {
        if (!pendingGoogleUser) return;
        const role = document.getElementById('googleRoleSelect').value;
        await saveUserProfile(pendingGoogleUser, role);
    }

    async function saveUserProfile(user, role) {
        try {
            await setDoc(doc(db, "users", user.uid), {
                fullName: user.displayName || 'Google User',
                email: user.email,
                role: role,
                createdAt: new Date().toISOString()
            });
            
            handleRedirect(role);
        } catch (error) {
            alert("Error saving profile: " + error.message);
        }
    }

    function handleRedirect(role) {
        localStorage.setItem('userRole', role);
        if (role === 'Farmer') window.location.href = 'farmer_dashboard.html';
        else if (role === 'Distributor') window.location.href = 'distributor_dashboard.html';
        else if (role === 'Quality Auditor') window.location.href = 'quality_dashboard.html';    
        else if (role === 'Government') window.location.href = 'government_dashboard.html';
        else if (role === 'Consumer') window.location.href = 'consumer_view.html';
        else window.location.href = 'farmer_dashboard.html'; 
    }

    document.getElementById('signupForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const fullName = this.querySelector('input[type="text"]').value;
        const email = this.querySelector('input[type="email"]').value;
        const password = this.querySelectorAll('input[type="password"]')[0].value;
        const confirmPassword = this.querySelectorAll('input[type="password"]')[1].value;
        const role = document.getElementById('roleSelect').value;
        const btn = this.querySelector('button[type="submit"]');
        const loginText = document.querySelector('.login-text');

        // Reset error display
        const existingError = document.getElementById('error-msg');
        if(existingError) existingError.remove();

        function showError(msg) {
            const errDiv = document.createElement('div');
            errDiv.id = 'error-msg';
            errDiv.style.color = '#d32f2f';
            errDiv.style.backgroundColor = '#ffebee';
            errDiv.style.border = '1px solid #ffcdd2';
            errDiv.style.padding = '10px';
            errDiv.style.marginTop = '15px';
            errDiv.style.borderRadius = '4px';
            errDiv.style.textAlign = 'center';
            errDiv.style.fontSize = '14px';
            errDiv.innerText = msg;
            loginText.parentNode.insertBefore(errDiv, loginText);
        }

        if(password !== confirmPassword) {
            showError("Passwords do not match!");
            return;
        }

        if(!role) {
            showError("Please select a role.");
            return;
        }

        if(password.length < 6) {
             showError("Password must be at least 6 characters.");
             return;
        }

        try {
            btn.innerText = 'Creating Account...';
            // 1. Create User in Auth
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            // 2. Store User Data & Role in Firestore
            await setDoc(doc(db, "users", user.uid), {
                fullName: fullName,
                email: email,
                role: role,
                password: password, // Storing password as requested
                createdAt: new Date().toISOString()
            });

            // 3. Local Storage fallback (optional, but good for quick access)
            localStorage.setItem('userRole', role);

            // Show Success Modal
            const successModal = document.getElementById('successModal');
            successModal.style.display = 'flex';
            
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);

        } catch (error) {
            console.error("Error signing up:", error);
            let errorMessage = "Error: " + error.message;
            
            // User-friendly error messages
            if (error.code === 'auth/email-already-in-use') {
                errorMessage = "This email is already associated with an account.";
            } else if (error.code === 'auth/operation-not-allowed') {
                errorMessage = "Email/Password sign-in is NOT enabled in the Firebase Console. Please enable it under Authentication > Sign-in method.";
            } else if (error.code === 'auth/weak-password') {
                errorMessage = "Password should be at least 6 characters.";
            } else if (error.code === 'permission-denied') {
                errorMessage = "Firestore Permission Denied. Please ensure your Database Rules allow writing (Start in Test Mode).";
            }

            showError(errorMessage);
            btn.innerText = 'CREATE ACCOUNT';
        }
    });
</script>

<script type="text/javascript">
function googleTranslateElementInit() {
  new google.translate.TranslateElement({pageLanguage: 'en'}, 'google_translate_element');
}
</script>
<script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>
<script>
    window.onerror = function(msg, url, line) {
        alert("JS Error: " + msg + " (Line " + line + ")");
    };
    window.addEventListener('unhandledrejection', function(event) {
        alert("Promise Error: " + event.reason);
    });
</script>
</body>
</html>
